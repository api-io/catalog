on:
  workflow_dispatch: {}
  push:
    paths:
      - .github/workflows/flat.yml
  schedule:
    - cron: "*/5 * * * *"
jobs:
  token:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ruby: [ '2.5', '2.6' ]

    steps:
      - name: get_token
        uses: actions/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          bundler-cache: true
      - run: ruby ./scripts/app_jwt.rb  >> $GITHUB_OUTPUT
        outputs:
          app_token: ${{GITHUB_OUTPUT}}
      
      
      
      - name: Get App Installation Token
        run: |
          echo "This token is masked: ${TOKEN}"
        env:
          APP_TOKEN: ${{ steps.get_token.outputs }}
      
  scheduled:
    runs-on: ubuntu-latest
    needs: token
    
    steps:
      - name: Setup deno
        uses: denoland/setup-deno@main
        with:
          deno-version: v1.10.x
      - name: Check out repo
        uses: actions/checkout@v2
        
   

      - name: Fetch data
        uses: githubocto/flat@v3
        with:
          http_url: https://api.github.com/installation/repositories
          downloaded_filename: store/repositories.json
          authorization: ${{ env.APP_TOKEN }}
